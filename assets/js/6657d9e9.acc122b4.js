"use strict";(self.webpackChunkdoc_center=self.webpackChunkdoc_center||[]).push([[78624],{42157:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>t,toc:()=>r});var s=n(74848),d=n(28453);const l={title:"\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4"},i=void 0,t={id:"topic/deployment/k8s-cluster-setup",title:"\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4",description:"kubeadm HA\u6a21\u5f0f\u5b89\u88c5\u5b98\u65b9\u6587\u6863",source:"@site/docs/00800-topic/deployment/k8s-cluster-setup.md",sourceDirName:"00800-topic/deployment",slug:"/topic/deployment/k8s-cluster-setup",permalink:"/dddtdd-docs/topic/deployment/k8s-cluster-setup",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedBy:"Colin Zuo",lastUpdatedAt:1720187019e3,frontMatter:{title:"\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4"},sidebar:"docSidebar",previous:{title:"\u4f7f\u7528ansible\u5de5\u7a0b\u90e8\u7f72",permalink:"/dddtdd-docs/topic/deployment/deploy-use-ansible-project"},next:{title:"\u642d\u5efaansible\u5de5\u7a0b",permalink:"/dddtdd-docs/topic/deployment/setup-ansible-project"}},c={},r=[{value:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load balancer",id:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load-balancer",level:2},{value:"\u5173\u95edswap",id:"\u5173\u95edswap",level:2},{value:"\u5b89\u88c5docker-ce",id:"\u5b89\u88c5docker-ce",level:2},{value:"\u5b89\u88c5kubelet kubeadm kubectl",id:"\u5b89\u88c5kubelet-kubeadm-kubectl",level:2},{value:"\u5b89\u88c5kubectl bash completion",id:"\u5b89\u88c5kubectl-bash-completion",level:2},{value:"\u4fee\u6539/etc/hosts",id:"\u4fee\u6539etchosts",level:2},{value:"\u51c6\u5907kubeadm-config.yaml",id:"\u51c6\u5907kubeadm-configyaml",level:2},{value:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5",id:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5",level:2},{value:"\u5b89\u88c5calico",id:"\u5b89\u88c5calico",level:2},{value:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165",id:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165",level:2},{value:"\u5b89\u88c5k8s Dashboard",id:"\u5b89\u88c5k8s-dashboard",level:2},{value:"\u52a0\u5165worker\u8282\u70b9",id:"\u52a0\u5165worker\u8282\u70b9",level:2},{value:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6",id:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6",level:2},{value:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6eVIP\u505a\u4e1a\u52a1HA",id:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6evip\u505a\u4e1a\u52a1ha",level:2},{value:"\u62c6\u9664k8s\u96c6\u7fa4(\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6)",id:"\u62c6\u9664k8s\u96c6\u7fa4\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6",level:2}];function o(e){const a={a:"a",br:"br",code:"code",h2:"h2",p:"p",pre:"pre",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/",children:"kubeadm HA\u6a21\u5f0f\u5b89\u88c5\u5b98\u65b9\u6587\u6863"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load-balancer",children:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load balancer"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://www.jordyverbeek.nl/nieuws/kubernetes-ha-cluster-installation-guide",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"sudo apt install -y keepalived haproxy\n\n# edit, update, restart keepalived\n# misc/kubeadm/keepalived.conf\nsudo cp keepalived.conf /etc/keepalived/\nsudo systemctl restart keepalived\n\n# edit, ,update, restart haproxy\n# misc/kubeadm/haproxy.cfg\nsudo cp haproxy.cfg /etc/haproxy/\nsudo systemctl restart haproxy\n"})}),"\n",(0,s.jsx)(a.p,{children:"\u53c2\u8003keepalived.conf\u914d\u7f6e\u6587\u4ef6\u89c1harix-deploy/misc/kubeadm/keepalived.conf\uff0c\u5f53\u524d\u7248\u672c\u5982\u4e0b\uff0c\u4e0d\u540c\u73af\u5883\u7684virtual_router_id\u9700\u8981\u4e0d\u4e00\u6837\uff0c\u540c\u4e00\u4e2a\u73af\u5883\u7684\u4e0d\u540c\u673a\u5668\u7684priority\u5e94\u8be5\u4e0d\u4e00\u6837"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"vrrp_instance VI_1 {\n    state MASTER\n    interface ens160\n    virtual_router_id 161\n    priority 101\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    unicast_peer {\n        172.16.23.55\n        172.16.23.56\n        172.16.23.57\n    }\n    virtual_ipaddress {\n        172.16.23.61\n    }\n}\n"})}),"\n",(0,s.jsx)(a.p,{children:"\u53c2\u8003haproxy.cfg\u914d\u7f6e\u6587\u4ef6\u89c1harix-deploy/misc/kubeadm/haproxy.cfg"}),"\n",(0,s.jsx)(a.h2,{id:"\u5173\u95edswap",children:"\u5173\u95edswap"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://serverfault.com/questions/684771/best-way-to-disable-swap-in-linux",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5docker-ce",children:"\u5b89\u88c5docker-ce"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/setup/production-environment/container-runtimes/",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5kubelet-kubeadm-kubectl",children:"\u5b89\u88c5kubelet kubeadm kubectl"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5kubectl-bash-completion",children:"\u5b89\u88c5kubectl bash completion"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubectl completion bash >/etc/bash_completion.d/kubectl\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u4fee\u6539etchosts",children:"\u4fee\u6539/etc/hosts"}),"\n",(0,s.jsx)(a.p,{children:"\u9996\u5148\u8bbe\u7f6e\u673a\u5668\u7684hosts\u6587\u4ef6\uff0c\u4e00\u4e2a\u662fload balancer\u5730\u5740\uff0c\u6bd4\u5982\u4e0b\u976223.60\u662f\u524d\u9762lb\u4e0a\u914d\u7f6e\u7684vip\u5730\u5740\uff0c\u4e00\u4e2a\u662fharbor\u7684\u5730\u5740\u6bd4\u5982\u4e0b\u9762\u768413.133"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:"# edit /etc/hosts, such as\n172.16.23.60  harix45lb\n172.16.13.133 harbor.cloudminds.com\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u51c6\u5907kubeadm-configyaml",children:"\u51c6\u5907kubeadm-config.yaml"}),"\n",(0,s.jsx)(a.p,{children:"\u7136\u540e\u51c6\u5907kubeadm-config.yaml\u6587\u4ef6\uff0c\u53c2\u8003\u89c1misc/kubeadm/kubeadm-config.yaml\uff0c\u5f53\u524d\u7248\u672c\u5185\u5bb9\u5982\u4e0b (\u7528\u4e8e61\u73af\u5883\uff0c\u5176\u5b83\u73af\u5883\u81f3\u5c11\u5e94\u6539lb\u5730\u5740)"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{children:'apiVersion: kubeadm.k8s.io/v1beta2\nkind: ClusterConfiguration\nkubernetesVersion: stable\ncontrolPlaneEndpoint: "harix45lb:443"\nnetworking:\n  podSubnet: 10.222.0.0/16\n'})}),"\n",(0,s.jsx)(a.h2,{id:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5",children:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubeadm init --config=kubeadm-config.yaml --upload-certs\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5calico",children:"\u5b89\u88c5calico"}),"\n",(0,s.jsxs)(a.p,{children:["\u4e0b\u8f7d",(0,s.jsx)(a.a,{href:"https://docs.projectcalico.org/v3.8/manifests/calico.yaml%E5%B9%B6%E6%8C%89%E7%85%A7%E5%89%8D%E9%9D%A2kubeadm-config.yaml%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9CALICO_IPV4POOL_CIDR%EF%BC%8C%E5%8F%AF%E5%AF%B9%E7%85%A7misc/kubeadm/calico.yaml",children:"https://docs.projectcalico.org/v3.8/manifests/calico.yaml\u5e76\u6309\u7167\u524d\u9762kubeadm-config.yaml\u6587\u4ef6\u4fee\u6539CALICO_IPV4POOL_CIDR\uff0c\u53ef\u5bf9\u7167misc/kubeadm/calico.yaml"})]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubectl apply -f calico.yaml\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165",children:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165"}),"\n",(0,s.jsx)(a.p,{children:"kubeadm init\u7ed3\u5c3e\u4f1a\u7ed9join\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubeadm join harix45lb:443 --token io7jk5.ndanb8hbe7cpn1q2 \\\n    --discovery-token-ca-cert-hash sha256:9eb562b0cabe93c48f6cb5e074ddcaa226d038d4fb201b6e49145267485d7296\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5k8s-dashboard",children:"\u5b89\u88c5k8s Dashboard"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta1/aio/deploy/recommended.yaml\n"})}),"\n",(0,s.jsx)(a.p,{children:"\u53c2\u7167kubespray\u5b9e\u73b0\uff0c\u53efapply misc/dashboard/dashboard-api.yaml\u6765\u5141\u8bb8\u96c6\u7fa4\u5916\u8bbf\u95eeapi\u4ece\u800c\u8bbf\u95eedashboard"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubectl apply -f dashboard-api.yaml\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u52a0\u5165worker\u8282\u70b9",children:"\u52a0\u5165worker\u8282\u70b9"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/",children:"\u53c2\u8003\u6587\u6863"})}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"kubeadm token create --print-join-command\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6",children:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6"}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"sudo apt-get install -y python nfs-common\n"})}),"\n",(0,s.jsx)(a.h2,{id:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6evip\u505a\u4e1a\u52a1ha",children:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6eVIP\u505a\u4e1a\u52a1HA"}),"\n",(0,s.jsxs)(a.p,{children:["\u56e0\u4e3a\u5728\u4e1a\u52a1\u7cfb\u7edf\u7ecf\u5e38\u9700\u8981\u914d\u4e00\u4e2a\u5916\u90e8\u8bbf\u95ee\u5730\u5740\uff0c\u5982\u679c\u914d\u67d0\u53f0node\u7684\u56fa\u5b9aip\u7684\u8bdd\u5982\u679c\u8fd9\u53f0\n\u673a\u5668\u5b95\u673a\u4e86\u5916\u90e8\u8bbf\u95ee\u5c31\u4f1a\u4e2d\u65ad\uff0c\u5728\u6ca1\u6709\u4e13\u95e8load balancer\u8bbe\u5907\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528keepalived\u914d\u7f6eVIP\u6765\u5b9e\u73b0HA",(0,s.jsx)(a.br,{}),"\n",(0,s.jsx)(a.a,{href:"https://tecadmin.net/setup-ip-failover-on-ubuntu-with-keepalived/",children:"\u53c2\u8003\u6587\u6863"}),(0,s.jsx)(a.br,{}),"\n",(0,s.jsx)(a.a,{href:"https://github.com/acassen/keepalived/issues/836",children:"\u6ce8\u610fissue"}),"\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u8f7d\u6700\u65b0keepalived\u6e90\u7801\u7f16\u8bd1\u7136\u540e\u66ff\u6362\u7cfb\u7edf\u91cc\u7684keepalived\u7a0b\u5e8f\u66f4\u65b0"]}),"\n",(0,s.jsx)(a.pre,{children:(0,s.jsx)(a.code,{className:"language-bash",children:"cd /usr/sbin/\nmv keepalived keepalived.bak\nscp colinzuo@172.16.23.53:/usr/local/sbin/keepalived .\nsystemctl restart keepalived.service\nip addr del 172.16.23.60/32 dev ens160;ip addr\n"})}),"\n",(0,s.jsxs)(a.p,{children:["\u540c\u65f6\u53ef\u53c2\u8003\u524d\u9762",(0,s.jsx)(a.a,{href:"#%E5%AE%89%E8%A3%85%E5%9F%BA%E4%BA%8Ehaproxy%E7%9A%84load-balancer",children:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load-balancer"}),"\u4e2d\u7684keepalived\u90e8\u5206"]}),"\n",(0,s.jsx)(a.h2,{id:"\u62c6\u9664k8s\u96c6\u7fa4\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6",children:"\u62c6\u9664k8s\u96c6\u7fa4(\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6)"}),"\n",(0,s.jsx)(a.p,{children:(0,s.jsx)(a.a,{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/",children:"\u53c2\u8003\u6587\u6863"})})]})}function p(e={}){const{wrapper:a}={...(0,d.R)(),...e.components};return a?(0,s.jsx)(a,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},28453:(e,a,n)=>{n.d(a,{R:()=>i,x:()=>t});var s=n(96540);const d={},l=s.createContext(d);function i(e){const a=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function t(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:i(e.components),s.createElement(l.Provider,{value:a},e.children)}}}]);