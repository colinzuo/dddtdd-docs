"use strict";(self.webpackChunkdoc_center=self.webpackChunkdoc_center||[]).push([[4443],{7574:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var o=t(74848),r=t(28453);const i={},s=void 0,a={id:"topic/grpc/protobuf-go",title:"protobuf-go",description:"gotutorial",source:"@site/docs/00800-topic/grpc/020-protobuf-go.md",sourceDirName:"00800-topic/grpc",slug:"/topic/grpc/protobuf-go",permalink:"/dddtdd-docs/topic/grpc/protobuf-go",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedBy:"Colin Zuo",lastUpdatedAt:1720187019e3,sidebarPosition:20,frontMatter:{},sidebar:"docSidebar",previous:{title:"protobuf",permalink:"/dddtdd-docs/topic/grpc/protobuf"},next:{title:"grpc",permalink:"/dddtdd-docs/topic/grpc/grpc"}},l={},c=[{value:"gotutorial",id:"gotutorial",level:2},{value:"go-generated",id:"go-generated",level:2},{value:"Compiler Invocation",id:"compiler-invocation",level:3},{value:"Packages",id:"packages",level:3},{value:"Messages",id:"messages",level:3},{value:"Fields",id:"fields",level:3},{value:"Singular Scalar Fields (proto3)",id:"singular-scalar-fields-proto3",level:3},{value:"Singular Message Fields",id:"singular-message-fields",level:3},{value:"Oneof Fields",id:"oneof-fields",level:3},{value:"Enumerations",id:"enumerations",level:3},{value:"pkg proto",id:"pkg-proto",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"gotutorial",children:"gotutorial"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://protobuf.dev/getting-started/gotutorial/",children:"https://protobuf.dev/getting-started/gotutorial/"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"go install google.golang.org/protobuf/cmd/protoc-gen-go@latest\n\nprotoc -I=$SRC_DIR --go_out=$DST_DIR $SRC_DIR/addressbook.proto\n"})}),"\n",(0,o.jsx)(n.h2,{id:"go-generated",children:"go-generated"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://protobuf.dev/reference/go/go-generated/",children:"https://protobuf.dev/reference/go/go-generated/"})}),"\n",(0,o.jsx)(n.h3,{id:"compiler-invocation",children:"Compiler Invocation"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Where in the output directory the generated .pb.go file is placed depends on the compiler flags"}),". There are several output modes:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["If the ",(0,o.jsx)(n.code,{children:"paths=import"})," flag is specified, the output file is placed in a directory named after the Go package\u2019s import path. For example, an input file protos/buzz.proto with a Go import path of example.com/project/protos/fizz results in an output file at example.com/project/protos/fizz/buzz.pb.go. This is the ",(0,o.jsx)(n.strong,{children:"default"})," output mode if a paths flag is not specified."]}),"\n",(0,o.jsxs)(n.li,{children:["If the ",(0,o.jsx)(n.code,{children:"module=$PREFIX"})," flag is specified, the output file is placed in a directory named after the Go package\u2019s import path, but with the specified directory prefix removed from the output filename. For example, an input file protos/buzz.proto with a Go import path of example.com/project/protos/fizz and example.com/project specified as the module prefix results in an output file at protos/fizz/buzz.pb.go. Generating any Go packages outside the module path results in an error. This mode is ",(0,o.jsx)(n.strong,{children:"useful for outputting generated files directly into a Go module"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["If the ",(0,o.jsx)(n.code,{children:"paths=source_relative"})," flag is specified, the output file is placed in the same relative directory as the input file. For example, an input file protos/buzz.proto results in an output file at protos/buzz.pb.go."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"The compiler automatically creates nested output sub-directories if necessary, but will not create the output directory itself"}),"\n",(0,o.jsx)(n.h3,{id:"packages",children:"Packages"}),"\n",(0,o.jsxs)(n.p,{children:["We ",(0,o.jsx)(n.strong,{children:"recommend"})," declaring it within the .proto file so that the Go packages for .proto files can be centrally identified with the .proto files themselves and to simplify the set of flags passed when invoking protoc"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'option go_package = "example.com/project/protos/fizz";\n'})}),"\n",(0,o.jsx)(n.h3,{id:"messages",children:"Messages"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"message Artist {}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["An ",(0,o.jsx)(n.code,{children:"*Artist"})," implements the ",(0,o.jsx)(n.code,{children:"proto.Message"})," interface"]}),"\n",(0,o.jsx)(n.h3,{id:"fields",children:"Fields"}),"\n",(0,o.jsx)(n.p,{children:"The case-conversion works as follows:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["The first letter is capitalized for export. If the first character is an underscore, it is removed and a capital ",(0,o.jsx)(n.code,{children:"X"})," is prepended."]}),"\n",(0,o.jsx)(n.li,{children:"If an interior underscore is followed by a lower-case letter, the underscore is removed, and the following letter is capitalized."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"singular-scalar-fields-proto3",children:"Singular Scalar Fields (proto3)"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"int32 birth_year = 1;\noptional int32 first_active_year = 2;\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The FirstActiveYear struct field will be of type ",(0,o.jsx)(n.code,{children:"*int32"}),", and additionally have the ",(0,o.jsx)(n.code,{children:"HasFirstActiveYear()"})," and ",(0,o.jsx)(n.code,{children:"ClearFirstActiveYear()"})," accessors, because it is marked ",(0,o.jsx)(n.strong,{children:"optional"})]}),"\n",(0,o.jsx)(n.h3,{id:"singular-message-fields",children:"Singular Message Fields"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"message Band {}\n\nmessage Concert {\n  Band headliner = 1;\n}\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type Concert struct {\n    Headliner *Band\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"oneof-fields",children:"Oneof Fields"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"package account;\nmessage Profile {\n  oneof avatar {\n    string image_url = 1;\n    bytes image_data = 2;\n  }\n}\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'type Profile struct {\n    // Types that are valid to be assigned to Avatar:\n    //  *Profile_ImageUrl\n    //  *Profile_ImageData\n    Avatar isProfile_Avatar `protobuf_oneof:"avatar"`\n}\n\ntype Profile_ImageUrl struct {\n        ImageUrl string\n}\ntype Profile_ImageData struct {\n        ImageData []byte\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["To access the field, you can use a ",(0,o.jsx)(n.strong,{children:"type switch"})," on the value to handle the different message types"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'switch x := m.Avatar.(type) {\ncase *account.Profile_ImageUrl:\n    // Load profile image based on URL\n    // using x.ImageUrl\ncase *account.Profile_ImageData:\n    // Load profile image based on bytes\n    // using x.ImageData\ncase nil:\n    // The field is not set.\ndefault:\n    return fmt.Errorf("Profile.Avatar has unexpected type %T", x)\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"enumerations",children:"Enumerations"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"enum Genre {\n  GENRE_UNSPECIFIED = 0;\n  GENRE_ROCK = 1;\n  GENRE_INDIE = 2;\n  GENRE_DRUM_AND_BASS = 3;\n  // ...\n}\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'type Genre int32\n\nconst (\n    Genre_GENRE_UNSPECIFIED   Genre = 0\n    Genre_GENRE_ROCK          Genre = 1\n    Genre_GENRE_INDIE         Genre = 2\n    Genre_GENRE_DRUM_AND_BASS Genre = 3\n)\n\nvar Genre_name = map[int32]string{\n    0: "GENRE_UNSPECIFIED",\n    1: "GENRE_ROCK",\n    2: "GENRE_INDIE",\n    3: "GENRE_DRUM_AND_BASS",\n}\nvar Genre_value = map[string]int32{\n    "GENRE_UNSPECIFIED":   0,\n    "GENRE_ROCK":          1,\n    "GENRE_INDIE":         2,\n    "GENRE_DRUM_AND_BASS": 3,\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"pkg-proto",children:"pkg proto"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://github.com/protocolbuffers/protobuf-go",children:"https://github.com/protocolbuffers/protobuf-go"}),"\n",(0,o.jsx)(n.a,{href:"https://pkg.go.dev/google.golang.org/protobuf/proto",children:"https://pkg.go.dev/google.golang.org/protobuf/proto"}),"\n",(0,o.jsx)(n.a,{href:"https://pkg.go.dev/google.golang.org/protobuf/types/known/anypb",children:"https://pkg.go.dev/google.golang.org/protobuf/types/known/anypb"})]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"func Bool(v bool) *bool"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"func Float32(v float32) *float32"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"func Marshal(m Message) ([]byte, error)"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"func Unmarshal(b []byte, m Message) error"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"type Message = protoreflect.ProtoMessage"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"func Clone(m Message) Message"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var o=t(96540);const r={},i=o.createContext(r);function s(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);