"use strict";(self.webpackChunkdoc_center=self.webpackChunkdoc_center||[]).push([[92689],{99178:(n,r,e)=>{e.r(r),e.d(r,{assets:()=>o,contentTitle:()=>a,default:()=>c,frontMatter:()=>i,metadata:()=>p,toc:()=>l});var t=e(74848),d=e(28453);const i={},a="Transform Your Data with Aggregation",p={id:"middleware/mongo/pymongo/aggregation",title:"Transform Your Data with Aggregation",description:"Filtered Subset",source:"@site/docs/00600-middleware/mongo/pymongo/070-aggregation.md",sourceDirName:"00600-middleware/mongo/pymongo",slug:"/middleware/mongo/pymongo/aggregation",permalink:"/dddtdd-docs/middleware/mongo/pymongo/aggregation",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedBy:"Colin Zuo",lastUpdatedAt:1734870983e3,sidebarPosition:70,frontMatter:{},sidebar:"docSidebar",previous:{title:"Optimize Queries with Indexes",permalink:"/dddtdd-docs/middleware/mongo/pymongo/indexes"},next:{title:"Mysql\u4ecb\u7ecd",permalink:"/dddtdd-docs/middleware/mysql/"}},o={},l=[{value:"Filtered Subset",id:"filtered-subset",level:2},{value:"Group and Total",id:"group-and-total",level:2},{value:"Unpack Arrays and Group",id:"unpack-arrays-and-group",level:2},{value:"One-to-One Join",id:"one-to-one-join",level:2},{value:"Multi-Field Join",id:"multi-field-join",level:2}];function s(n){const r={code:"code",h1:"h1",h2:"h2",pre:"pre",...(0,d.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"transform-your-data-with-aggregation",children:"Transform Your Data with Aggregation"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-py",children:'pipeline = [\r\n    { "$match": { "cuisine": "Bakery" } },\r\n    { "$group": { "_id": "$borough", "count": { "$sum": 1 } } }\r\n]\r\n# Execute the aggregation\r\naggCursor = collection.aggregate(pipeline)\n'})}),"\n",(0,t.jsx)(r.h2,{id:"filtered-subset",children:"Filtered Subset"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-py",children:'pipeline.append({\r\n    "$match": {\r\n        "vocation": "ENGINEER"\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$sort": {\r\n        "dateofbirth": -1\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$limit": 3\r\n})\r\n\r\npipeline.append({\r\n    "$unset": [\r\n        "_id",\r\n        "address"\r\n    ]\r\n})\r\n\r\naggregation_result = person_coll.aggregate(pipeline)\n'})}),"\n",(0,t.jsx)(r.h2,{id:"group-and-total",children:"Group and Total"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-py",children:'pipeline.append({\r\n    "$match": {\r\n        "orderdate": {\r\n            "$gte": datetime(2020, 1, 1, 0, 0, 0),\r\n            "$lt": datetime(2021, 1, 1, 0, 0, 0)\r\n        }\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$sort": {\r\n        "orderdate": 1\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$group": {\r\n        "_id": "$customer_id",\r\n        "first_purchase_date": {"$first": "$orderdate"},\r\n        "total_value": {"$sum": "$value"},\r\n        "total_orders": {"$sum": 1},\r\n        "orders": {"$push": {"orderdate": "$orderdate", "value": "$value"}}\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$sort": {\r\n        "first_purchase_date": 1\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$set": {\r\n        "customer_id": "$_id"\r\n    }\r\n})\r\n\r\npipeline.append({"$unset": ["_id"]})\r\n\r\naggregation_result = orders_coll.aggregate(pipeline)\n'})}),"\n",(0,t.jsx)(r.h2,{id:"unpack-arrays-and-group",children:"Unpack Arrays and Group"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-py",children:'pipeline.append({\r\n    "$unwind": {\r\n        "path": "$products"\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$match": {\r\n        "products.price": {\r\n            "$gt": 15\r\n        }\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$group": {\r\n        "_id": "$products.prod_id",\r\n        "product": {"$first": "$products.name"},\r\n        "total_value": {"$sum": "$products.price"},\r\n        "quantity": {"$sum": 1}\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$set": {\r\n        "product_id": "$_id"\r\n    }\r\n})\r\n\r\npipeline.append({"$unset": ["_id"]})\r\n\r\naggregation_result = orders_coll.aggregate(pipeline)\n'})}),"\n",(0,t.jsx)(r.h2,{id:"one-to-one-join",children:"One-to-One Join"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-py",children:'pipeline.append({\r\n    "$match": {\r\n        "orderdate": {\r\n            "$gte": datetime(2020, 1, 1, 0, 0, 0),\r\n            "$lt": datetime(2021, 1, 1, 0, 0, 0)\r\n        }\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$lookup": {\r\n        "from": "products",\r\n        "localField": "product_id",\r\n        "foreignField": "id",\r\n        "as": "product_mapping"\r\n    }\r\n})\r\n\r\npipeline.extend([\r\n    {\r\n        "$set": {\r\n            "product_mapping": {"$first": "$product_mapping"}\r\n        }\r\n    },\r\n    {\r\n        "$set": {\r\n            "product_name": "$product_mapping.name",\r\n            "product_category": "$product_mapping.category"\r\n        }\r\n    }\r\n])\r\n\r\npipeline.append({"$unset": ["_id", "product_id", "product_mapping"]})\r\n\r\naggregation_result = orders_coll.aggregate(pipeline)\n'})}),"\n",(0,t.jsx)(r.h2,{id:"multi-field-join",children:"Multi-Field Join"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-py",children:'embedded_pl = [\r\n    {\r\n        "$match": {\r\n            "$expr": {\r\n                "$and": [\r\n                    {"$eq": ["$product_name", "$$prdname"]},\r\n                    {"$eq": ["$product_variation", "$$prdvartn"]}\r\n                ]\r\n            }\r\n        }\r\n    }\r\n]\r\n\r\nembedded_pl.append({\r\n    "$match": {\r\n        "orderdate": {\r\n            "$gte": datetime(2020, 1, 1, 0, 0, 0),\r\n            "$lt": datetime(2021, 1, 1, 0, 0, 0)\r\n        }\r\n    }\r\n})\r\n\r\nembedded_pl.append({\r\n    "$unset": ["_id", "product_name", "product_variation"]\r\n})\r\n\r\npipeline.append({\r\n    "$lookup": {\r\n        "from": "orders",\r\n        "let": {\r\n            "prdname": "$name",\r\n            "prdvartn": "$variation"\r\n        },\r\n        "pipeline": embedded_pl,\r\n        "as": "orders"\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$match": {\r\n        "orders": {"$ne": []}\r\n    }\r\n})\r\n\r\npipeline.append({\r\n    "$unset": ["_id", "description"]\r\n})\r\n\r\naggregation_result = products_coll.aggregate(pipeline)\n'})})]})}function c(n={}){const{wrapper:r}={...(0,d.R)(),...n.components};return r?(0,t.jsx)(r,{...n,children:(0,t.jsx)(s,{...n})}):s(n)}},28453:(n,r,e)=>{e.d(r,{R:()=>a,x:()=>p});var t=e(96540);const d={},i=t.createContext(d);function a(n){const r=t.useContext(i);return t.useMemo((function(){return"function"==typeof n?n(r):{...r,...n}}),[r,n])}function p(n){let r;return r=n.disableParentContext?"function"==typeof n.components?n.components(d):n.components||d:a(n.components),t.createElement(i.Provider,{value:r},n.children)}}}]);